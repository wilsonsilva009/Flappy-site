<!DOCTYPE html>
<html lang="pt-pt">


<head>
    <!-- FONTS -->

    <!-- LONDRINA SOLID-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Londrina+Solid:wght@100;300;400;900&display=swap" rel="stylesheet">

    <!-- FONTS -->

    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Your profile Flappy PIP</title>
	<link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>

<style>

    body{
        background-image: url('Images/RegisterBackground.png');
    }

    body *{
        font-family: "Londrina Solid", sans-serif;
    }

    .image-holder{
        position: relative;
        width: fit-content;
        height: fit-content;
    }

    .profile-header{
        display: flex;
        gap: 25px;

        font-weight: bold;
        color: white;
        -webkit-text-stroke: .1rem black;

        padding: 2vh 6vw;
    }

    .profile-header img{
        border-radius: 100%;
        width: 15vw;
    }

    #edit-button{
        position: absolute;
        width: 5vw;
        right: 0;
        bottom: 0;
    }

    .profile-welcome{
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;

        padding: 2rem 0;
        letter-spacing: 4px;
    }

    .profile-welcome>label{
        font-size: 3rem;
        -webkit-text-stroke: .13rem black;
        word-break: break-word;
        width: 100%;
    }

    .online-status{
        display: flex;
        align-items: center;
        gap: 20px;

        
        font-size: 2rem;
    }

    .online-status>div{
        height: 25px;
        width: 25px;

        background: #00FF00;
        border: 2px solid #009d00;
        border-radius: 50px;
    }

    .options-holder{
        display: flex;
        flex-direction: column;
        width: fit-content;
        gap: 2vh;
        
        color: white;
        font-weight: bold;
        font-size: 1.5rem;
        
        padding: 0vh 6vw;
    }

    .options-holder h1{
        -webkit-text-stroke: .1rem black;
    }

    #deleteaccount{
        color: white;
        text-shadow: 5px 5px 4px rgba(0,0,0,.5);
        font-size: 1.4rem;
        font-weight: bold;
        font-family: "Londrina Solid", sans-serif;

        background-color: #FF2E2E;
        border: 5px solid #FF0000;
        width: fit-content;

        letter-spacing: 4px;
        padding: 10px 25px;
        border-radius: 15px;

        transition: all .3s ease;
    }

    #deleteaccount:hover{
        transform: scale(.95);
        box-shadow: inset 0px 0px 40px 2px rgba(0, 0, 0,.4);
    }

    #deleteaccount:active{
        transform: scale(.95) translateX(10px);
    }

    #changepassword{
        color: white;
        text-shadow: 5px 5px 4px rgba(0,0,0,.5);
        font-size: 1.4rem;
        font-weight: bold;
        font-family: "Londrina Solid", sans-serif;

        background-color: #2E2EFF;
        border: 5px solid #0000FF;
        width: fit-content;

        letter-spacing: 4px;
        padding: 10px 25px;
        border-radius: 15px;

        transition: all .3s ease;
    }

    #changepassword:hover{
        transform: scale(.95);
        box-shadow: inset 0px 0px 40px 2px rgba(0, 0, 0,.4);
    }

    #changepassword:active{
        transform: scale(.95) translateX(10px);
    }

    .deleteconfirm-holder, .changepassword-holder{
        opacity: 0;
        pointer-events: none;

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;

        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
        width: 35vw;
        height: 25vh;
        max-width: 415px;
        
		color: #1F1F1F;
        background-color: #D9D9D9;
        padding: 20px;
        border-radius: 20px;
        font-size: 1.5rem;

        text-shadow: 0px 0px 5px rgba(0,0,0,.25);
        transition: all .3s ease;
    }

    .changepassword-holder{
        height: 40vh;
        width: 35vw;
    }

    .deleteconfirm-holder:hover, .changepassword-holder:hover{
        box-shadow: inset 0px 0px 10px -5px rgba(0, 0, 0,.4);
    }

    .deleteconfirm-holder>:nth-child(3){
        align-self: flex-start;
        font-size: 1.1rem;
    }

    .changepassword-holder>:nth-child(3), .changepassword-holder>:nth-child(5){
        align-self: flex-start;
        font-size: 1.2rem;
    }

    .changepassword-holder input{
        align-self: flex-start;

        background-color: rgba(0,0,0,.15);
        border-radius: 60px;
        border: 1px solid black;
        font-size: 1.3rem;

        margin-left: 25px;
        padding-left: 10px;

        height: 10%;
        width: 65%;
    }

    .deleteconfirm-holder>div:not(#buttons-holder), .changepassword-holder>div:not(#buttons-holder){
        height: 4px;
        width: 100%;
        border-radius: 1000px;
        
        background-color: rgba(177, 177, 177, .5);
    }

    #buttons-holder{
        display: flex;
        align-self: flex-end;
        gap: 15px;
    }

    #buttons-holder button{
        display: flex;
        justify-content: center;
        align-items: center;

        height: 30px;
        width: 100px;

        border-radius: 60px;
        border: 1px solid black;
        box-shadow: inset 0px 0px 10px -5px rgba(0, 0, 0,.4), 3px 3px 5px rgba(0,0,0,.25);

		transition: all .3s ease;
    }

	#buttons-holder button:hover{
		transform: scale(1.2);
		margin: 0 5px;
        box-shadow: inset 0px 0px 25px 0px rgba(0, 0, 0,.4), 3px 3px 5px rgba(0,0,0,.25);
	}

    #buttons-holder button:active{
        transform: scale(1.2) translateY(-5px);
    }


    #buttons-holder>:nth-child(1){
        background-color: #FF5B5B;
    }

    #buttons-holder>:nth-child(2){
        background-color: #5BFF5B;
    }

    #buttons-holder img{
        height: 70%;
    }

	/*     STATS     */
	.stats-holder{
		display: flex;
		flex-direction: column;
		align-items: center;

		position: absolute;
		top: 20vh;
		right: 10vw;

		width: 31vw;
		height: 75vh;

		background-color: rgb(0 62 101 / 90%);
        box-shadow: 8px 8px 3px rgba(0, 0, 0, .5);
		border-radius: 15px;
		overflow-y: auto;
		
		-ms-overflow-style: none;
        scrollbar-width: none; /* Esconder scroll bar */

		color: white;
		letter-spacing: 2px;
	}

	.stats-holder>div:not(.achievements-list, .items-grid){
		min-height: 3px;
        width: 80%;
        border-radius: 60px;
        
        background-color: #D9D9D9;
	}

	.stats-holder label:not(#stats){
		font-size: 1.7rem;
	}

	.stats-holder>*{
		margin: 10px 0;
	}

	.items-grid{
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		justify-content: space-evenly;
		width: 80%;
		gap: 20px;
	}

	.items-grid>div{
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		gap: 10px;
	}

	.achievements-list{
		display: grid;
		grid-template-columns: 1fr;
		width: 80%;
		gap: 15px;
	}

	.achievements-list>div{
		display: flex;
		flex-direction: column;

		background-color: rgba(38,38,38,.5);
		border-radius: 17px;
		padding: 10px;
	}

	.achievements-list>div>label{
		text-align: center;
	}

	.achievement-progress{
		display: flex;
		align-items: center;
		justify-content: space-between;
	}


	.progress-bar{
		height: 10px;
		width: 80%;

		border-radius: 60px;

		background-color: #D9D9D9;
	}

	.progress-bar>div{
		width: 50%;
		height: 100%;

		border-radius: 60px 0 0 60px;

		background-color: #FF6200;
	}

	#stats{
		text-align: center;
		line-height: 2rem;
        font-size: 1.5rem;
	}

    /*     MOBILE     */
    @media (max-width: 600px) {
        .profile-header{
            flex-direction: column;
            align-items: center;
        }

        .profile-header img{
            width: 50vw;
        }
        
        #edit-button{
            width: 15vw;
        }

        .stats-holder{
            position: static;
            width: 90vw;
            margin: 0 auto;
        }

        .options-holder{
            padding: 5vh 4vw;
        }

        .deleteconfirm-holder, .changepassword-holder{
            top: 75%;
            width: 75vw;
        }

        
    }
</style>

<body>

    <header>
        <a href="index.html"><img src="Images/LOGO.png"></a>
        <a href="download.html" target="_blank"><button>Instalar</button></a>
    </header>

    <div class="profile-header">

        <div class="image-holder">
            <img src="Images/game_logo.png">
            <img onclick="EditProfile()" id="edit-button" src="Images/EditButton.png">
        </div>
        
        <div class="profile-welcome">
            <div class="online-status">
                <div></div>
                <label>online</label>
            </div>

            <label>Olá, admin!</label>
        </div>

    </div>

	<div class="stats-holder">

		<label>Itens</label>
		<div></div>
		<div class="items-grid"></div>


		<label>Conquistas</label>
		<div></div>
		<div class="achievements-list"></div>


		<label>Estatísticas</label>
		<div></div>
		<label id="stats"></label>

	</div>


    <div class="options-holder">
        <h1>Opções:</h1>
            <button onclick="DeleteAccountVisibility()" id="deleteaccount">Apagar conta</button>
            <button onclick="ChangePasswordVisibility()" id="changepassword">Mudar password</button>
        </div>
    </div>


    <!--DELETE ACCOUNT-->

    <div class="deleteconfirm-holder">
        <label>Tem a certeza?</label>
        <div></div>
        <label>Não será possível reverter esta ação</label>
        <div></div>
        <div id="buttons-holder">
            <button onclick="DeleteAccountClose()" id="delete-close"><img src="Images/Cross.png"></button>
            <button onclick="DeleteAccount()" id="delete-confirm"><img src="Images/Check.png"></button>
        </div>
    </div>
    

    <!--CHANGE PASSWORD-->

    <div class="changepassword-holder">
        <label>Alterar a password</label>
        <div></div>
        <label>Password antiga</label>
        <input id="oldpassword" type="text">
        <label>Password nova</label>
        <input id="newpassword" type="text">
        <div></div>
        <div id="buttons-holder">
            <button onclick="ChangePasswordClose()" id="changepass-close"><img src="Images/Cross.png"></button>
            <button onclick="ChangePassword()" id="changepass-confirm"><img src="Images/Check.png"></button>
        </div>
    </div>

    <div class="error-holder">
        <label></label>
    </div>
</body>

<script>
    var FirebaseURL = "https://flappy-pip-default-rtdb.europe-west1.firebasedatabase.app/"
    const Username = localStorage.getItem("Username");

    /*---------------------------------------------------------------------------*/

    //No user found, return to login
    if (!Username){
        window.location.href = "index.html";
    }

    //Get data async function
    async function FillData(){
        var URL = FirebaseURL + Username + ".json";

        const response = await fetch(URL);
        const data = await response.json();

        if (data !== null) {
            
            //Fill powers
            const powers = data["powers"];
            console.log(powers);
            if (powers.length){
                for (power in powers){
                    if (powers[power] > 0)
                        document.querySelector(".items-grid").innerHTML += `<div><img src="Images/${power}.png" width="100%"><label>${data["powers"][power]}</label></div>`;
                }
            }
            //Fill achievements
            const achievements = data["achievements"];
            console.log(achievements);
            for (achievement in achievements){
                const progress1 = achievements[achievement]["Progress"][0];
                const progress2 = achievements[achievement]["Progress"][1];

                var radius = "60px 0 0 60px";
                if (progress1 >= progress2) radius = "60px";

                document.querySelector(".achievements-list").innerHTML += `<div><label>${achievement}</label><div class="achievement-progress"><label style="font-size: 1.5rem;">${progress1}/${progress2}</label><div class="progress-bar"><div style="width: ${(progress1 / progress2) * 100}%; border-radius: ${radius};"></div></div></div><label style="font-size: 1rem; margin-top: 5%;">${achievements[achievement].Description}</label></div>`;
            }

            //Fill stats
            const stats = data["stats"];

            document.querySelector("#stats").innerHTML = `Games played<br> ${stats["GamesPlayed"]}<br><br>Seconds survived<br> ${stats["SecondsSurvived"]}s<br><br>Distance traveled<br> ${stats["DistanceTraveled"] / 1000}km<br><br>Obstacles overcome<br> ${stats["ObstaclesOvercome"]}<br><br>Favorite power<br> ${stats["FavoritePower"]}<br><br>Coins collected<br> ${stats["CoinsCollected"]}c<br><br>Coins spent<br> ${stats["CoinsSpent"]}c<br><br>`;
        
        }
    }

    //Change title
    document.title = `${Username} - Flappy PIP`;

    //Change welcome message
    document.querySelector(".profile-welcome>label").innerText = `Olá, ${Username}!`;

    //Fill data
    FillData();




    /*---------------------------------------------------------------------------*/
    async function DeleteAccount(){
        var URL = FirebaseURL + Username + ".json";

        const response = await fetch(URL, {method: 'DELETE'});

        localStorage.removeItem("Username");
        window.location.href = "index.html"
    }

    async function ChangePassword(){
        const oldpassword = document.getElementById("oldpassword").value;
        const newpassword = document.getElementById("newpassword").value

        var URL = FirebaseURL + Username + ".json";

        const response = await fetch(URL);
        const data = await response.json();

        if (data !== null) {
            if (data.password != oldpassword){
                ShowError("Password errada");
                return;
            }
            data.password = newpassword

            const newData = JSON.stringify(data);

            fetch(URL, {
                method: 'PUT',
                headers: {},
                body: newData
            })

            document.getElementById("newpassword").value = "";
            ChangePasswordClose();
        } else{
            ShowError("Utilizador não existe");
        }
    }

    function EditProfile(){
        ShowError("Em breve...");
    }


    function DeleteAccountVisibility(){
        document.querySelector(".deleteconfirm-holder").style.opacity = "1";
        document.querySelector(".deleteconfirm-holder").style.pointerEvents = "auto";
    }

    function DeleteAccountClose(){
        document.querySelector(".deleteconfirm-holder").style.opacity = "0";
        document.querySelector(".deleteconfirm-holder").style.pointerEvents = "none";
    }

    function ChangePasswordVisibility(){
        document.querySelector(".changepassword-holder").style.opacity = "1";
        document.querySelector(".changepassword-holder").style.pointerEvents = "auto";
    }

    function ChangePasswordClose(){
        document.querySelector(".changepassword-holder").style.opacity = "0";
        document.querySelector(".changepassword-holder").style.pointerEvents = "none";
    }
    
</script>


</html>